name: Workflow Health Check

on:
  schedule:
    # Ejecutar cada lunes a las 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Permitir ejecuciÃ³n manual

jobs:
  health-check:
    name: Workflow Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install optional dependencies
        run: |
          npm install --no-save --force lightningcss-linux-x64-gnu @tailwindcss/oxide-linux-x64-gnu
          cp node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node node_modules/lightningcss/
          cp node_modules/@tailwindcss/oxide-linux-x64-gnu/tailwindcss-oxide.linux-x64-gnu.node node_modules/@tailwindcss/oxide/

      - name: Create environment file for validation
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GOOGLE_MAPS_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
        run: |
          echo "ðŸ”§ Configurando variables de entorno para validaciÃ³n..."

          # Usar valores de secrets o placeholders para desarrollo
          SUPABASE_URL_VALUE="${SUPABASE_URL:-https://placeholder.supabase.co}"
          SUPABASE_ANON_KEY_VALUE="${SUPABASE_ANON_KEY:-placeholder-key}"
          SUPABASE_SERVICE_KEY_VALUE="${SUPABASE_SERVICE_KEY:-placeholder-service-key}"
          GOOGLE_MAPS_KEY_VALUE="${GOOGLE_MAPS_KEY:-placeholder-maps-key}"

          # Crear archivo .env.local
          echo "NEXT_PUBLIC_SUPABASE_URL=$SUPABASE_URL_VALUE" >> .env.local
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY_VALUE" >> .env.local
          echo "SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_KEY_VALUE" >> .env.local
          echo "NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_KEY_VALUE" >> .env.local

          echo "âœ… Archivo .env.local creado para validaciÃ³n"

      - name: Validate workflows
        run: npm run validate-workflows

      - name: Check workflow files syntax
        run: |
          echo "ðŸ” Verificando sintaxis de archivos YAML..."
          for file in .github/workflows/*.yml; do
            echo "Validando $file..."
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || {
              echo "âŒ Error de sintaxis en $file"
              exit 1
            }
            echo "âœ… $file - OK"
          done

      - name: Check for outdated actions
        run: |
          echo "ðŸ” Verificando versiones de actions..."
          outdated_actions=()

          # Verificar checkout
          if grep -r "actions/checkout@v[0-4]" .github/workflows/; then
            outdated_actions+=("actions/checkout")
          fi

          # Verificar setup-node
          if grep -r "actions/setup-node@v[0-4]" .github/workflows/; then
            outdated_actions+=("actions/setup-node")
          fi

          if [ ${#outdated_actions[@]} -gt 0 ]; then
            echo "âš ï¸ Actions desactualizadas encontradas:"
            printf '%s\n' "${outdated_actions[@]}"
            echo "Considera actualizar a las versiones mÃ¡s recientes"
          else
            echo "âœ… Todas las actions estÃ¡n actualizadas"
          fi

      - name: Check secrets configuration
        run: |
          echo "ðŸ” Verificando configuraciÃ³n de secrets..."
          required_secrets=(
            "NEXT_PUBLIC_SUPABASE_URL"
            "NEXT_PUBLIC_SUPABASE_ANON_KEY"
            "SUPABASE_SERVICE_ROLE_KEY"
            "NEXT_PUBLIC_GOOGLE_MAPS_API_KEY"
          )

          missing_secrets=()
          for secret in "${required_secrets[@]}"; do
            if [ -z "${!secret}" ]; then
              missing_secrets+=("$secret")
            fi
          done

          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "âš ï¸ Secrets faltantes (esto es normal en el contexto de GitHub Actions):"
            printf '%s\n' "${missing_secrets[@]}"
            echo "AsegÃºrate de que estos secrets estÃ©n configurados en GitHub"
          else
            echo "âœ… Todos los secrets estÃ¡n configurados"
          fi

      - name: Generate health report
        run: |
          echo "# ðŸ“Š Workflow Health Report" > health-report.md
          echo "**Fecha:** $(date)" >> health-report.md
          echo "**Commit:** ${{ github.sha }}" >> health-report.md
          echo "" >> health-report.md
          echo "## âœ… Checks realizados:" >> health-report.md
          echo "- [x] ValidaciÃ³n de workflows" >> health-report.md
          echo "- [x] VerificaciÃ³n de sintaxis YAML" >> health-report.md
          echo "- [x] VerificaciÃ³n de versiones de actions" >> health-report.md
          echo "- [x] VerificaciÃ³n de configuraciÃ³n de secrets" >> health-report.md
          echo "" >> health-report.md
          echo "## ðŸ“ PrÃ³ximos pasos:" >> health-report.md
          echo "1. Revisar cualquier advertencia mostrada arriba" >> health-report.md
          echo "2. Actualizar actions si es necesario" >> health-report.md
          echo "3. Configurar secrets faltantes en GitHub" >> health-report.md

      - name: Upload health report
        uses: actions/upload-artifact@v5
        with:
          name: workflow-health-report
          path: health-report.md
