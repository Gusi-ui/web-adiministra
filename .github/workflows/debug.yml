name: Debug Workflow

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  debug:
    name: Debug Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check Node.js version
        run: |
          echo "Node.js version: $(node --version)"
          echo "NPM version: $(npm --version)"

      - name: Check package.json
        run: |
          echo "Package.json type field:"
          cat package.json | grep '"type"'
          echo "Package.json engines:"
          cat package.json | grep -A 3 '"engines"'

      - name: Install dependencies
        run: npm ci

      - name: Install optional dependencies
        run: |
          npm install --no-save --force lightningcss-linux-x64-gnu @tailwindcss/oxide-linux-x64-gnu
          cp node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node node_modules/lightningcss/
          cp node_modules/@tailwindcss/oxide-linux-x64-gnu/tailwindcss-oxide.linux-x64-gnu.node node_modules/@tailwindcss/oxide/

      - name: Check if .env.local exists
        run: |
          if [ -f .env.local ]; then
            echo ".env.local exists"
            echo "Contents (without values):"
            cat .env.local | sed 's/=.*/=***/'
          else
            echo ".env.local does not exist"
          fi

      - name: Create minimal .env.local
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=https://placeholder.supabase.co" >> .env.local
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=placeholder-key" >> .env.local
          echo "SUPABASE_SERVICE_ROLE_KEY=placeholder-service-key" >> .env.local
          echo "NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=placeholder-maps-key" >> .env.local

      - name: Test basic commands
        run: |
          echo "Testing type-check..."
          npm run type-check
          echo "Testing lint..."
          npm run lint
          echo "Testing format check..."
          npm run format:check

      - name: Test build
        run: npm run build
